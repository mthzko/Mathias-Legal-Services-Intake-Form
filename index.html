<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vinterra SMP – Legal Intake Form</title>
  <style>
    :root{
      --bg:#0b0d12;
      --card:#121621;
      --muted:#9aa6b2;
      --text:#e8edf2;
      --accent:#7c5cff;
      --accent2:#2dd4bf;
      --bgGrad1: rgba(124,92,255,.18);
      --bgGrad2: rgba(45,212,191,.12);
      --danger:#ef4444;
      --border:#222a3b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --bubble-width: 340px;
      --bubble-gap: 24px;
      --bubble-bg: rgba(18,22,33,.92);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 600px at 20% 0%, var(--bgGrad1), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, var(--bgGrad2), transparent 55%),
        var(--bg);
      color:var(--text);
      line-height:1.4;
      transition: background 250ms ease;
    }
    .wrap{
      max-width: 980px;
      margin: 40px auto;
      padding: 0 18px 80px;
    }
    header{
      display:flex;
      justify-content:space-between;
      gap:16px;
      align-items:flex-start;
      margin-bottom: 18px;
    }
    h1{
      margin:0;
      font-size: clamp(22px, 3vw, 32px);
      letter-spacing:.2px;
    }
    .sub{
      margin: 8px 0 0;
      color:var(--muted);
      max-width: 70ch;
      font-size: 14px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size: 13px;
      user-select:none;
      white-space:nowrap;
    }
    .pill b{ color: var(--text); font-weight:600; }
    form{
      background: rgba(255,255,255,.02);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .section{
      padding: 18px;
      border-top: 1px solid var(--border);
    }
    .section:first-child{ border-top:0; }
    .section h2{
      margin:0 0 12px;
      font-size: 16px;
      color: #dfe7ff;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .section h2 span{
      font-size: 12px;
      color: var(--muted);
      font-weight: 500;
    }
    .grid{
      display:grid;
      gap: 12px;
    }
    @media (min-width: 760px){
      .grid.two{ grid-template-columns: 1fr 1fr; }
      .grid.three{ grid-template-columns: 1fr 1fr 1fr; }
    }
    label{
      display:block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    input[type="text"],
    input[type="date"],
    textarea,
    select{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      outline:none;
    }
    textarea{
      min-height: 110px;
      resize: vertical;
    }
    input::placeholder, textarea::placeholder{ color: rgba(154,166,178,.6); }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(124,92,255,.55);
      box-shadow: 0 0 0 3px rgba(124,92,255,.12);
    }
    .row{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .checks{
      display:flex;
      flex-wrap:wrap;
      gap: 10px 14px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255,255,255,.02);
    }
    .checks label{
      margin:0;
      display:flex;
      gap:8px;
      align-items:center;
      color: var(--text);
      font-size: 13px;
      user-select:none;
    }
    .checks input{ accent-color: var(--accent); }
    .small{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }
    .actions{
      padding: 16px 18px;
      border-top: 1px solid var(--border);
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
      background: rgba(0,0,0,.12);
    }
    button{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
    }
    button:hover{ border-color: rgba(124,92,255,.55); }
    .primary{
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(45,212,191,.75));
      border-color: transparent;
      color:#091019;
    }

    /* Scary/defendant button style */
    .primary-defendant{
      background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(96,165,250,.75));
      border-color: transparent;
      color:#091019;
      box-shadow:
        0 0 0 2px rgba(239,68,68,.18),
        0 10px 30px rgba(0,0,0,.35),
        0 0 18px rgba(239,68,68,.22);
    }

    .primary-defendant:hover{
      transform: translateY(-1px);
      box-shadow:
        0 0 0 2px rgba(239,68,68,.28),
        0 14px 34px rgba(0,0,0,.38),
        0 0 26px rgba(239,68,68,.32);
    }

    /* Make the inactive defendant tab still look a bit ominous */
    #tabDefendant{
      border-color: rgba(239,68,68,.45);
      background: rgba(239,68,68,.08);
      color: #ffd7d7;
    }

    #tabDefendant:hover{
      border-color: rgba(239,68,68,.70);
    }
    .danger{
      border-color: rgba(239,68,68,.45);
      color: #ffd7d7;
      background: rgba(239,68,68,.08);
    }
    .right{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .muted{
      color: var(--muted);
      font-size: 13px;
    }
    .list{
      display:grid;
      gap:10px;
    }
    .item{
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .item input[type="text"]{ flex: 1; }
    .item button{ padding: 10px 10px; border-radius: 12px; }
    .divider{
      height:1px;
      background: var(--border);
      margin: 12px 0;
    }
    .error{
      display:none;
      margin-top:10px;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(239,68,68,.45);
      background: rgba(239,68,68,.08);
      color:#ffd7d7;
      font-size: 13px;
    }
    .success{
      display:none;
      margin-top:10px;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(45,212,191,.4);
      background: rgba(45,212,191,.08);
      color:#d7fff7;
      font-size: 13px;
    }
    pre{
      background: rgba(0,0,0,.25);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      overflow:auto;
      font-family: var(--mono);
      font-size: 12px;
      color: #d6deff;
    }
    .footer-note{
      margin-top: 16px;
      color: var(--muted);
      font-size: 12px;
    }
    .kbd{
      font-family: var(--mono);
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 8px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      display:inline-block;
    }

    .output-bubble{
      position: fixed;
      top: 110px;
      width: min(var(--bubble-width), 90vw);
      max-height: calc(100vh - 160px);
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 18px;
      background: var(--bubble-bg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 50;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    body.bubble-right .output-bubble{
      right: var(--bubble-gap);
      left: auto;
    }

    body.bubble-left .output-bubble{
      left: var(--bubble-gap);
      right: auto;
    }

    .output-bubble h2{
      margin: 0 0 6px;
      font-size: 15px;
      color: #dfe7ff;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .output-bubble h2 span{
      font-size: 11px;
      color: var(--muted);
      font-weight: 500;
    }

    .output-bubble .bubble-actions{
      margin: 4px 0 6px;
    }

    .output-bubble .doc{
      flex: 1 1 auto;
      min-height: 140px;
      overflow: auto;
    }

    .output-bubble .footer-note{
      margin-top: 8px;
    }

    @media (min-width: 1201px){
      body.bubble-right{
        padding-right: calc(var(--bubble-width) + var(--bubble-gap));
      }

      body.bubble-left{
        padding-left: calc(var(--bubble-width) + var(--bubble-gap));
      }
    }

    @media (max-width: 1200px){
      .output-bubble{
        position: static;
        top: auto;
        bottom: auto;
        left: auto;
        right: auto;
        width: 100%;
        max-height: none;
        margin: 16px 0;
      }

      body.bubble-right,
      body.bubble-left{
        padding-left: 0;
        padding-right: 0;
      }
    }

    /* Document-style output (what users actually see/send) */
    .doc{
      background: rgba(0,0,0,.25);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      color: var(--text);
      font-size: 13px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: var(--sans);
    }

    /* Theme swapping */
    body.theme-plaintiff{
      --accent:#7c5cff;
      --accent2:#2dd4bf;
      --bgGrad1: rgba(124,92,255,.18);
      --bgGrad2: rgba(45,212,191,.12);
    }

    body.theme-defendant{
      --accent:#ef4444;
      --accent2:#60a5fa;
      --bgGrad1: rgba(239,68,68,.16);
      --bgGrad2: rgba(96,165,250,.12);
    }

    /* Fullscreen "mode picker" overlay */
    .mode-overlay{
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
      background: rgba(11,13,18,.92);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      opacity: 1;
      transition: opacity 220ms ease;
    }

    .mode-overlay.hidden{
      opacity: 0;
      pointer-events: none;
    }

    .mode-card{
      width: min(720px, 100%);
      border: 1px solid var(--border);
      border-radius: 20px;
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      padding: 18px;
    }

    .mode-card h2{
      margin: 0 0 8px;
      font-size: 18px;
      color: #dfe7ff;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .mode-card p{
      margin: 0 0 14px;
      color: var(--muted);
      font-size: 13px;
      max-width: 70ch;
    }

    .mode-actions{
      display: grid;
      gap: 12px;
    }

    @media (min-width: 760px){
      .mode-actions{ grid-template-columns: 1fr 1fr; }
    }

    .mode-btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 14px 14px;
      border-radius: 16px;
      cursor: pointer;
      text-align: left;
      transition: transform 140ms ease, border-color 140ms ease;
    }

    .mode-btn:hover{
      transform: translateY(-1px);
      border-color: rgba(124,92,255,.55);
    }

    .mode-btn .title{
      font-weight: 800;
      font-size: 14px;
      display:block;
      margin-bottom: 6px;
    }

    .mode-btn .desc{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
      display:block;
    }

    .mode-btn.plaintiff{
      background: linear-gradient(135deg, rgba(124,92,255,.25), rgba(45,212,191,.12));
    }

    .mode-btn.defendant{
      background: linear-gradient(135deg, rgba(239,68,68,.22), rgba(96,165,250,.12));
    }

    .mode-footer{
      margin-top: 14px;
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      color: var(--muted);
      font-size: 12px;
    }

    .ghost-link{
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
    }

    .ghost-link:hover{ border-color: rgba(124,92,255,.55); }
  </style>
</head>

<body class="bubble-left">
  <div class="mode-overlay" id="modeOverlay" aria-modal="true" role="dialog">
    <div class="mode-card">
      <h2>Pick a form <span style="font-size:12px; color: var(--muted); font-weight:500;">(yes, like a cookie banner, but useful)</span></h2>
      <p>
        Pick what you’re here for. This just tweaks the form and the vibe.
      </p>

      <div class="mode-actions">
        <button type="button" class="mode-btn plaintiff" id="overlayPlaintiffBtn">
          <span class="title">I want to sue</span>
          <span class="desc">File a claim, submit evidence, list damages, demand emotional compensation.</span>
        </button>

        <button type="button" class="mode-btn defendant" id="overlayDefendantBtn">
          <span class="title">I got sued</span>
          <span class="desc">Respond to allegations, add your evidence, choose outcomes, consider counter-suing.</span>
        </button>
      </div>

      <div class="mode-footer">
        <span>Tip: You can switch tabs later. This just makes you pick a lane first.</span>
        <button type="button" class="ghost-link" id="overlayCloseBtn">Skip</button>
      </div>
    </div>
  </div>
  <div class="wrap">
    <header>
      <div>
        <h1>Vinterra SMP – Mathias' Legal Services Intake Form</h1>
        <p class="sub">
          Fill this out before your lawyer (Mathias) even pretends to care. Clear info + real evidence makes your case stronger.
          “They were being weird” is not evidence. Unless it was Taco. Then we already know.
        </p>
      </div>
 <div class="row" style="justify-content:flex-end; gap:10px;">
  <button type="button" id="tabPlaintiff" class="primary" style="padding:8px 12px; border-radius:999px;">
    I want to sue
  </button>
  <button type="button" id="tabDefendant" style="padding:8px 12px; border-radius:999px; font-weight:800;">
    I got sued
  </button>

  <div class="pill" id="casePill" title="Generated on submit">
    Case ID: <b id="caseId">Not submitted</b>
  </div>
</div>
    </header>
    <div id="outputTopAnchor">
      <aside class="output-bubble" aria-live="polite">
        <h2>Submission Document <span>(this is what gets sent)</span></h2>
        <div class="row bubble-actions">
          <button type="button" id="copyBtn">Copy Document</button>
          <button type="button" id="downloadBtn">Download Document</button>
          <button type="button" id="webhookBtn">Send to Discord</button>
          <label class="muted" style="display:inline-flex; gap:8px; align-items:center;">
            <input type="checkbox" id="autoWebhook" checked /> Auto-send on submit
          </label>
          <span class="muted">Copy: <span class="kbd">Ctrl</span>+<span class="kbd">C</span> works too.</span>
        </div>
        <div id="output" class="doc">No submission yet.</div>
        <div class="footer-note">
          Note: This document is your official submission record. Keep a copy for yourself.
        </div>
      </aside>
    </div>

    <form id="intakeForm" novalidate>
      <!-- Section 1: Client info -->
      <div class="section">
        <h2>Section 1: Client Information <span>(who is complaining)</span></h2>
        <div class="grid two">
          <div>
            <label for="clientIgn">In-Game Name (IGN) *</label>
            <input id="clientIgn" name="clientIgn" type="text" placeholder="e.g., MathiasK0" required />
          </div>
          <div>
            <label for="clientDiscord">Discord Username *</label>
            <input id="clientDiscord" name="clientDiscord" type="text" placeholder="e.g., mthzko or @Mathias" required />
          </div>
        </div>

        <div class="divider"></div>

        <div>
          <label>Are you the affected party? *</label>
          <div class="checks">
            <label><input type="radio" name="affectedParty" value="yes" required /> Yes</label>
            <label><input type="radio" name="affectedParty" value="no" required /> No</label>
          </div>
          <p class="small">If “No”, explain the connection below.</p>
        </div>

        <div>
          <label for="relationshipExplain">Connection / relationship (if not affected party)</label>
          <input id="relationshipExplain" name="relationshipExplain" type="text" placeholder="e.g., I'm filing on behalf of my friend / my shop / my chicken cult" />
        </div>
      </div>

      <!-- Section 2: Defendant info -->
      <div class="section">
        <h2>Section 2: Defendant Information <span>(who you’re suing)</span></h2>
        <div class="grid two">
          <div>
            <label for="defendantIgn">Defendant IGN *</label>
            <input id="defendantIgn" name="defendantIgn" type="text" placeholder="e.g., TACOWITHER" required />
          </div>
          <div>
            <label for="defendantAlts">Other involved players</label>
            <input id="defendantAlts" name="defendantAlts" type="text" placeholder="e.g., SoroF1ed and Foelligs." />
          </div>
        </div>
      </div>

      <!-- Section 3: Case type -->
      <div class="section">
        <h2>Section 3: Type of Case <span>(pick your poison)</span></h2>
        <div class="checks" id="caseTypes">
          <label><input type="checkbox" name="caseType" value="Griefing" /> Griefing (Blowing up your stuff)</label>
          <label><input type="checkbox" name="caseType" value="Theft" /> Theft (Taking your only Isaac head)</label>
          <label><input type="checkbox" name="caseType" value="Property Damage" /> Property Damage (Burning down your BIG HORRENDOUS TREE)</label>
          <label><input type="checkbox" name="caseType" value="Endangerment" /> Endangerment (Unlit builds = creepers galore)</label>
          <label><input type="checkbox" name="caseType" value="Harassment" /> Harassment (TACOWITHER existing)</label>
          <label><input type="checkbox" name="caseType" value="Contract Dispute" /> Permit/Shop Dispute</label>
          <label><input type="checkbox" id="caseTypeOtherChk" /> Other</label>
        </div>
        <div style="margin-top:10px">
          <label for="caseTypeOther">Other (describe)</label>
          <input id="caseTypeOther" name="caseTypeOther" type="text" placeholder="e.g., 'Cut off every statue's head'" disabled />
        </div>
        <p class="small">You should select at least one. If you don’t, why are you here?</p>
      </div>

      <!-- Section 4: Incident details -->
      <div class="section">
        <h2>Section 4: Incident Details <span>(what happened, where, when)</span></h2>
        <div class="grid three">
          <div>
            <label for="incidentDateStart">Incident start date *</label>
            <input id="incidentDateStart" name="incidentDateStart" type="date" required />
          </div>
          <div>
            <label for="incidentDateEnd">Incident end date</label>
            <input id="incidentDateEnd" name="incidentDateEnd" type="date" />
          </div>
          <div>
            <label for="incidentLocation">Location (coords/landmark) *</label>
            <input id="incidentLocation" name="incidentLocation" type="text" placeholder="e.g., X: 6767 Z: -Aura / Winter Village" required />
          </div>
        </div>

        <div style="margin-top:12px">
          <label for="incidentDescription">Detailed description *</label>
          <textarea id="incidentDescription" name="incidentDescription" placeholder="Explain clearly: actions, sequence, what you saw, what was said. Keep it factual." required></textarea>
        </div>
      </div>

      <!-- Section 5: Evidence -->
      <div class="section">
        <h2>Section 5: Evidence Submitted <span>(links beat vibes)</span></h2>
        <div class="checks">
          <label><input type="checkbox" name="evidenceType" value="Video clips" /> Video clip(s)</label>
          <label><input type="checkbox" name="evidenceType" value="Screenshots" /> Screenshots</label>
          <label><input type="checkbox" name="evidenceType" value="Chat logs" /> Chat logs</label>
          <label><input type="checkbox" name="evidenceType" value="Witness statements" /> Witness statements</label>
          <label><input type="checkbox" id="evidenceOtherChk" /> Other</label>
        </div>
        <div style="margin-top:10px">
          <label for="evidenceOther">Other (describe)</label>
          <input id="evidenceOther" name="evidenceOther" type="text" placeholder="e.g., 'Map record', 'Chest history screenshot'" disabled />
        </div>

        <div class="divider"></div>

        <div>
          <label>Evidence links / descriptions (add as many as needed)</label>
          <div class="list" id="evidenceList"></div>
          <div class="row" style="margin-top:10px">
            <button type="button" id="addEvidenceBtn">+ Add evidence</button>
            <span class="muted">Examples: Medal link, Twitch clip, Discord attachment URL, description of where it is.</span>
          </div>
        </div>
      </div>

      <!-- Section 6: Witnesses -->
      <div class="section">
        <h2>Section 6: Witnesses <span>(people who saw it)</span></h2>
        <div>
          <label>Witness IGN(s)</label>
          <div class="list" id="witnessList"></div>
          <div class="row" style="margin-top:10px">
            <button type="button" id="addWitnessBtn">+ Add witness</button>
            <span class="muted">Witnesses should be willing to show up. If they ghost us that's on you.</span>
          </div>
        </div>
      </div>

      <!-- Section 7: Damages / outcome -->
      <div class="section">
        <h2>Section 7: Damages & Desired Outcome <span>(what you want)</span></h2>
        <div>
          <label for="damages">What (if anything) was lost or damaged? *</label>
          <textarea id="damages" name="damages" placeholder="List items/builds, quantity, and approximate effort/time if relevant." required></textarea>
        </div>

        <div style="margin-top:12px">
          <label>What are you seeking? *</label>
          <div class="checks" id="remedies">
            <label><input type="checkbox" name="remedy" value="Item/material replacement" /> Item/material replacement</label>
            <label><input type="checkbox" name="remedy" value="Financial compensation" /> Diamond compensation</label>
            <label><input type="checkbox" name="remedy" value="Forced rebuild/repair" /> Forced rebuild/repair</label>
            <label><input type="checkbox" name="remedy" value="Public apology" /> Public (humiliating) apology</label>
            <label><input type="checkbox" name="remedy" value="Injunction (stay away)" /> Chunk ban (applies to Taco every time)</label>
            <label><input type="checkbox" id="remedyOtherChk" /> Other</label>
          </div>
          <div style="margin-top:10px">
            <label for="remedyOther">Other (describe)</label>
            <input id="remedyOther" name="remedyOther" type="text" placeholder="e.g., 'Ban from voicechat for 2 weeks'" disabled />
          </div>
        </div>
      </div>

      <!-- Section 8: Extra notes -->
      <div class="section">
        <h2>Section 8: Additional Notes <span>(optional but helpful)</span></h2>
        <label for="notes">Anything else?</label>
        <textarea id="notes" name="notes" placeholder="Anything you think matters. Keep it relevant."></textarea>
      </div>

      <!-- Section 9: Declaration -->
      <div class="section">
        <h2>Section 9: Declaration <span>(don’t lie)</span></h2>
        <div class="checks">
          <label><input type="checkbox" id="truthCheck" required /> I confirm the info provided is truthful to the best of my knowledge.</label>
          <label><input type="checkbox" id="understandCheck" required /> I understand weak evidence/exaggeration hurts my case and Mathias' image.</label>
        </div>
        <div class="grid two" style="margin-top:12px">
          <div>
            <label for="signature">Signature (IGN) *</label>
            <input id="signature" name="signature" type="text" placeholder="Type your IGN" required />
          </div>
          <div>
            <label for="signDate">Date *</label>
            <input id="signDate" name="signDate" type="date" required />
          </div>
        </div>

        <div class="error" id="errorBox"></div>
        <div class="success" id="successBox"></div>
      </div>

      <div class="actions">
        <div class="muted">
          Tip: Double-check before submitting. Thx.
        </div>
        <div class="right">
          <button type="button" class="danger" id="resetBtn">Reset</button>
          <button type="submit" class="primary">Submit Case</button>
        </div>
      </div>
    </form>
    <div id="outputBottomPlaintiff"></div>

    <form id="defendantForm" novalidate style="display:none; margin-top:16px;">
  <!-- DEFENDANT FORM: Section 1 -->
  <div class="section">
    <h2>Section 1: Defendant Information <span>(hi, yes, you’re being sued)</span></h2>
    <div class="grid two">
      <div>
        <label for="defIgn">Your IGN *</label>
        <input id="defIgn" name="defIgn" type="text" placeholder="e.g., TotallyInnocent" required />
      </div>
      <div>
        <label for="defDiscord">Your Discord *</label>
        <input id="defDiscord" name="defDiscord" type="text" placeholder="e.g., @defendant" required />
      </div>
    </div>

    <div class="grid two" style="margin-top:12px;">
  <div>
    <label for="suedCaseId">Case ID you were served (if known)</label>
    <input id="suedCaseId" name="suedCaseId" type="text" placeholder="e.g., VR-20260201-ABC123" />
  </div>
  <div>
    <label for="servedDate">Date you were served *</label>
    <input id="servedDate" name="servedDate" type="date" required />
  </div>
</div>

  <!-- DEFENDANT FORM: Section 2 -->
  <div class="section">
    <h2>Section 2: Plaintiff & Claim <span>(who’s coming for your diamonds)</span></h2>
    <div class="grid two">
      <div>
        <label for="plaintiffIgn">Plaintiff IGN *</label>
        <input id="plaintiffIgn" name="plaintiffIgn" type="text" placeholder="e.g., MathiasK0" required />
      </div>
      <div>
        <label for="plaintiffDiscord">Plaintiff Discord</label>
        <input id="plaintiffDiscord" name="plaintiffDiscord" type="text" placeholder="e.g., @plaintiff" />
      </div>
    </div>

    <div style="margin-top:12px;">
      <label for="allegations">What are you being accused of? *</label>
      <textarea id="allegations" name="allegations" placeholder="Copy/paste the claim or describe it. Keep it clear." required></textarea>
    </div>
  </div>

  <!-- DEFENDANT FORM: Section 3 -->
  <div class="section">
    <h2>Section 3: Your Response <span>(your side of the story)</span></h2>

    <div>
      <label for="defResponse">Your version of events *</label>
      <textarea id="defResponse" name="defResponse" placeholder="What happened, in order, with locations/coords if possible." required></textarea>
    </div>

    <div class="divider"></div>

    <div>
      <label>Position *</label>
      <div class="checks">
        <label><input type="radio" name="position" value="deny" required /> Deny (didn’t happen / wasn’t me)</label>
        <label><input type="radio" name="position" value="partial" required /> Partial (some true, some not)</label>
        <label><input type="radio" name="position" value="admit" required /> Admit (but with explanation/mitigation)</label>
      </div>
    </div>

    <div style="margin-top:12px;">
      <label for="defenses">Defenses / reasons you think you shouldn’t lose *</label>
      <textarea id="defenses" name="defenses" placeholder="Examples: lack of proof, permission, misunderstanding, server rules." required></textarea>
    </div>
  </div>

  <!-- DEFENDANT FORM: Section 4 -->
  <div class="section">
    <h2>Section 4: Evidence & Witnesses <span>(proof beats confidence)</span></h2>

    <div class="checks">
      <label><input type="checkbox" name="defEvidenceType" value="Video clips" /> Video clip(s)</label>
      <label><input type="checkbox" name="defEvidenceType" value="Screenshots" /> Screenshots</label>
      <label><input type="checkbox" name="defEvidenceType" value="Chat logs" /> Chat logs</label>
      <label><input type="checkbox" id="defEvidenceOtherChk" /> Other</label>
    </div>

    <div style="margin-top:10px">
      <label for="defEvidenceOther">Other (describe)</label>
      <input id="defEvidenceOther" name="defEvidenceOther" type="text" placeholder="e.g., server log excerpt" disabled />
    </div>

    <div class="divider"></div>

    <div>
      <label>Evidence links / descriptions</label>
      <div class="list" id="defEvidenceList"></div>
      <div class="row" style="margin-top:10px">
        <button type="button" id="addDefEvidenceBtn">+ Add evidence</button>
        <span class="muted">Links, screenshots, clips, whatever. Just not “trust me bro”.</span>
      </div>
    </div>

    <div class="divider"></div>

    <div>
      <label>Witness IGN(s)</label>
      <div class="list" id="defWitnessList"></div>
      <div class="row" style="margin-top:10px">
        <button type="button" id="addDefWitnessBtn">+ Add witness</button>
        <span class="muted">Only list people who’ll actually show up.</span>
      </div>
    </div>
  </div>

  <!-- DEFENDANT FORM: Section 5 -->
  <div class="section">
    <h2>Section 5: What you want to happen <span>(damage control)</span></h2>

    <div>
      <label>Are you interested in a settlement? *</label>
      <div class="checks">
        <label><input type="radio" name="settlement" value="yes" required /> Yes</label>
        <label><input type="radio" name="settlement" value="no" required /> No</label>
        <label><input type="radio" name="settlement" value="maybe" required /> Maybe</label>
      </div>
    </div>

    <div style="margin-top:12px;">
      <label>Preferred outcome *</label>
      <div class="checks" id="defOutcomes">
        <label><input type="checkbox" name="defOutcome" value="Case dismissed" /> Case dismissed</label>
        <label><input type="checkbox" name="defOutcome" value="Reduced damages" /> Reduced damages</label>
        <label><input type="checkbox" name="defOutcome" value="Pay back / replace items" /> Pay back / replace items</label>
        <label><input type="checkbox" name="defOutcome" value="Public clarification/apology" /> Public clarification/apology</label>
        <label><input type="checkbox" name="defOutcome" value="Mediation" /> Mediation</label>
        <label><input type="checkbox" id="defOutcomeOtherChk" /> Other</label>
      </div>

      <div style="margin-top:10px">
        <label for="defOutcomeOther">Other (describe)</label>
        <input id="defOutcomeOther" name="defOutcomeOther" type="text" placeholder="e.g., schedule a rebuild day" disabled />
      </div>
    </div>

    <div style="margin-top:12px;">
      <label>Do you want to countersue? *</label>
      <div class="checks">
        <label><input type="radio" name="counter" value="no" required /> No</label>
        <label><input type="radio" name="counter" value="maybe" required /> Maybe</label>
        <label><input type="radio" name="counter" value="yes" required /> Yes</label>
      </div>

      <p class="small">If yes/maybe, explain below.</p>
      <textarea id="counterExplain" name="counterExplain" placeholder="Briefly explain why you want to countersue, and what for."></textarea>
    </div>
  </div>

  <!-- DEFENDANT FORM: Section 6 -->
  <div class="section">
    <h2>Section 6: Declaration <span>(still don’t lie)</span></h2>

    <div class="checks">
      <label><input type="checkbox" id="defTruthCheck" required /> I confirm the info provided is truthful to the best of my knowledge.</label>
      <label><input type="checkbox" id="defUnderstandCheck" required /> I understand lying will make this worse (somehow).</label>
    </div>

    <div class="grid two" style="margin-top:12px">
      <div>
        <label for="defSignature">Signature (IGN) *</label>
        <input id="defSignature" name="defSignature" type="text" placeholder="Type your IGN" required />
      </div>
      <div>
        <label for="defSignDate">Date *</label>
        <input id="defSignDate" name="defSignDate" type="date" required />
      </div>
    </div>

    <div class="error" id="defErrorBox"></div>
    <div class="success" id="defSuccessBox"></div>
  </div>

  <div class="actions">
    <div class="muted">Tip: Don’t rage-type. It reads like guilt.</div>
    <div class="right">
      <button type="button" class="danger" id="defResetBtn">Reset</button>
      <button type="submit" class="primary">Submit Defense</button>
    </div>
  </div>
</form>
    <div id="outputBottomDefendant"></div>
  </div>

  <script>
    // Tiny DOM helpers
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    document.body.classList.add("theme-plaintiff");

    const outputBubble = document.querySelector(".output-bubble");
    const outputTopAnchor = document.getElementById("outputTopAnchor");
    const outputBottomPlaintiff = document.getElementById("outputBottomPlaintiff");
    const outputBottomDefendant = document.getElementById("outputBottomDefendant");
    const smallScreenQuery = window.matchMedia("(max-width: 1200px)");
    let outputMovedToBottom = false;

    function syncOutputPlacement() {
      if (!outputBubble || !outputTopAnchor) return;
      const plaintiffVisible = $("#intakeForm").style.display !== "none";
      const activeBottomAnchor = plaintiffVisible ? outputBottomPlaintiff : outputBottomDefendant;
      if (smallScreenQuery.matches) {
        if (outputMovedToBottom) {
          if (activeBottomAnchor) activeBottomAnchor.appendChild(outputBubble);
        } else {
          outputTopAnchor.appendChild(outputBubble);
        }
      } else {
        outputTopAnchor.appendChild(outputBubble);
      }
    }

    function scrollBubbleIntoView() {
      if (!outputBubble || !smallScreenQuery.matches) return;
      outputBubble.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    if (smallScreenQuery.addEventListener) {
      smallScreenQuery.addEventListener("change", syncOutputPlacement);
    } else if (smallScreenQuery.addListener) {
      smallScreenQuery.addListener(syncOutputPlacement);
    }
    window.addEventListener("resize", syncOutputPlacement);
    syncOutputPlacement();

    function randomId() {
      // "VR-" + date + random. It's not serious, it just looks official.
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const rand = Math.random().toString(36).slice(2, 8).toUpperCase();
      return `VR-${y}${m}${day}-${rand}`;
    }

    function todayISO() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function show(el, msg) {
      el.style.display = "block";
      el.textContent = msg;
    }
    function hide(el) {
      el.style.display = "none";
      el.textContent = "";
    }

    function addListItem(container, placeholder, kind) {
      const row = document.createElement("div");
      row.className = "item";

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = placeholder;
      input.setAttribute("data-kind", kind);

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "danger";
      btn.textContent = "Remove";
      btn.addEventListener("click", () => row.remove());

      row.appendChild(input);
      row.appendChild(btn);
      container.appendChild(row);
    }

    function getListValues(container, kind) {
      return Array.from(container.querySelectorAll(`input[data-kind="${kind}"]`))
        .map(i => i.value.trim())
        .filter(Boolean);
    }

    function downloadText(filename, text) {
      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Discord webhook note: this is client-side, so treat the URL like a public link.
    const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1467289266391613472/iWFehe7bhU6W8x6ZOt6BlAcLzyUO3H32Ia4yj2-5GO_UOVvVYFWxLk6Q1ZbaNgDi770m";

    async function sendToDiscordWebhook(docText, filenameBase, contextLabel, statusEl) {
      if (!DISCORD_WEBHOOK_URL) {
        show(statusEl, "Discord webhook not configured. Ask Mathias to paste the webhook URL into the site code.");
        statusEl.classList.remove("success");
        statusEl.classList.add("error");
        statusEl.style.display = "block";
        return;
      }

      try {
        const fileBlob = new Blob([docText], { type: "text/plain" });
        const form = new FormData();

        const content = `${contextLabel} submission received: ${filenameBase}`;
        form.append("payload_json", JSON.stringify({ content }));

        form.append("files[0]", fileBlob, `${filenameBase}.txt`);

        const res = await fetch(DISCORD_WEBHOOK_URL, {
          method: "POST",
          body: form
        });

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`Discord webhook failed (${res.status}). ${text}`);
        }

        statusEl.classList.remove("error");
        statusEl.classList.add("success");
        show(statusEl, "Sent to Discord.");
      } catch (err) {
        statusEl.classList.remove("success");
        statusEl.classList.add("error");
        show(statusEl, `Discord send failed: ${err.message}`);
      }
    }

    // Lists
    const evidenceList = $("#evidenceList");
    const witnessList = $("#witnessList");

    // Defendant form lists
    const defEvidenceList = $("#defEvidenceList");
    const defWitnessList = $("#defWitnessList");

    // Start with one input each
    addListItem(defEvidenceList, "Evidence link or description...", "defEvidence");
    addListItem(defWitnessList, "Witness IGN...", "defWitness");

    $("#addDefEvidenceBtn").addEventListener("click", () => {
      addListItem(defEvidenceList, "Evidence link or description...", "defEvidence");
    });
    $("#addDefWitnessBtn").addEventListener("click", () => {
      addListItem(defWitnessList, "Witness IGN...", "defWitness");
    });

    // Toggle "Other" fields
    $("#defEvidenceOtherChk").addEventListener("change", (e) => {
      $("#defEvidenceOther").disabled = !e.target.checked;
      if (!e.target.checked) $("#defEvidenceOther").value = "";
    });
    $("#defOutcomeOtherChk").addEventListener("change", (e) => {
      $("#defOutcomeOther").disabled = !e.target.checked;
      if (!e.target.checked) $("#defOutcomeOther").value = "";
    });

    // Default dates
    $("#defSignDate").value = todayISO();
    $("#servedDate").value = todayISO();

    // Mode tabs
    const tabPlaintiff = $("#tabPlaintiff");
    const tabDefendant = $("#tabDefendant");

    function setTab(which) {
      const isPlaintiff = which === "plaintiff";
      $("#intakeForm").style.display = isPlaintiff ? "block" : "none";
      $("#defendantForm").style.display = isPlaintiff ? "none" : "block";

      // Swap theme
      document.body.classList.toggle("theme-plaintiff", isPlaintiff);
      document.body.classList.toggle("theme-defendant", !isPlaintiff);

      if (isPlaintiff) {
        tabPlaintiff.classList.add("primary");
        tabPlaintiff.classList.remove("primary-defendant");

        tabDefendant.classList.remove("primary");
        tabDefendant.classList.remove("primary-defendant");
      } else {
        tabDefendant.classList.add("primary-defendant");
        tabDefendant.classList.remove("primary");

        tabPlaintiff.classList.remove("primary");
        tabPlaintiff.classList.remove("primary-defendant");
      }
      syncOutputPlacement();
    }

    tabPlaintiff.addEventListener("click", () => setTab("plaintiff"));
    tabDefendant.addEventListener("click", () => setTab("defendant"));

    // Fullscreen mode picker overlay
    const modeOverlay = $("#modeOverlay");
    const overlayPlaintiffBtn = $("#overlayPlaintiffBtn");
    const overlayDefendantBtn = $("#overlayDefendantBtn");
    const overlayCloseBtn = $("#overlayCloseBtn");

    function hideOverlay() {
      modeOverlay.classList.add("hidden");
      // Fully remove from layout after fade
      setTimeout(() => { modeOverlay.style.display = "none"; }, 260);
    }

    overlayPlaintiffBtn.addEventListener("click", () => {
      setTab("plaintiff");
      hideOverlay();
    });

    overlayDefendantBtn.addEventListener("click", () => {
      setTab("defendant");
      hideOverlay();
    });

    overlayCloseBtn.addEventListener("click", () => {
      // Default to plaintiff if they refuse to choose
      setTab("plaintiff");
      hideOverlay();
    });

    // ESC to skip
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && modeOverlay.style.display !== "none") {
        setTab("plaintiff");
        hideOverlay();
      }
    });

    // Start on plaintiff by default
    setTab("plaintiff");

    // Start with one input each (people forget otherwise)
    addListItem(evidenceList, "Evidence link or description...", "evidence");
    addListItem(witnessList, "Witness IGN...", "witness");

    $("#addEvidenceBtn").addEventListener("click", () => {
      addListItem(evidenceList, "Evidence link or description...", "evidence");
    });
    $("#addWitnessBtn").addEventListener("click", () => {
      addListItem(witnessList, "Witness IGN...", "witness");
    });

    // Toggle the "Other" fields
    $("#caseTypeOtherChk").addEventListener("change", (e) => {
      $("#caseTypeOther").disabled = !e.target.checked;
      if (!e.target.checked) $("#caseTypeOther").value = "";
    });
    $("#evidenceOtherChk").addEventListener("change", (e) => {
      $("#evidenceOther").disabled = !e.target.checked;
      if (!e.target.checked) $("#evidenceOther").value = "";
    });
    $("#remedyOtherChk").addEventListener("change", (e) => {
      $("#remedyOther").disabled = !e.target.checked;
      if (!e.target.checked) $("#remedyOther").value = "";
    });

    // Default sign date to today
    $("#signDate").value = todayISO();

    // Reset
    $("#resetBtn").addEventListener("click", () => {
      $("#intakeForm").reset();
      $("#signDate").value = todayISO();

      // Clear lists and add defaults
      evidenceList.innerHTML = "";
      witnessList.innerHTML = "";
      addListItem(evidenceList, "Evidence link or description...", "evidence");
      addListItem(witnessList, "Witness IGN...", "witness");

      // Disable "other" inputs again
      $("#caseTypeOther").disabled = true;
      $("#evidenceOther").disabled = true;
      $("#remedyOther").disabled = true;

      $("#caseId").textContent = "Not submitted";
      $("#output").textContent = "No submission yet.";
      lastSubmission = null;
      lastDocText = null;
      lastDocLabel = null;
      hide($("#errorBox"));
      hide($("#successBox"));
      outputMovedToBottom = false;
      syncOutputPlacement();
    });

    // Defendant reset
    $("#defResetBtn").addEventListener("click", () => {
      $("#defendantForm").reset();
      $("#defSignDate").value = todayISO();
      $("#servedDate").value = todayISO();

      defEvidenceList.innerHTML = "";
      defWitnessList.innerHTML = "";
      addListItem(defEvidenceList, "Evidence link or description...", "defEvidence");
      addListItem(defWitnessList, "Witness IGN...", "defWitness");

      $("#defEvidenceOther").disabled = true;
      $("#defOutcomeOther").disabled = true;

      hide($("#defErrorBox"));
      hide($("#defSuccessBox"));

      $("#caseId").textContent = "Not submitted";
      $("#output").textContent = "No submission yet.";
      lastDefense = null;
      lastDocText = null;
      lastDocLabel = null;
      outputMovedToBottom = false;
      syncOutputPlacement();
    });

    // Submissions
    let lastSubmission = null;
    let lastDefense = null;
    let lastDocText = null;
    let lastDocLabel = null;

    $("#intakeForm").addEventListener("submit", async (ev) => {
      ev.preventDefault();
      hide($("#errorBox"));
      hide($("#successBox"));

      // Basic validation
      const required = ["clientIgn", "clientDiscord", "defendantIgn", "incidentDateStart", "incidentLocation", "incidentDescription", "damages", "signature", "signDate"];
      for (const id of required) {
        const el = document.getElementById(id);
        if (!el.value.trim()) {
          show($("#errorBox"), `Missing required field: ${id}`);
          el.focus();
          return;
        }
      }

      const affected = $$('input[name="affectedParty"]:checked')[0]?.value;
      if (!affected) {
        show($("#errorBox"), "Select whether you are the affected party.");
        return;
      }
      if (affected === "no" && !$("#relationshipExplain").value.trim()) {
        show($("#errorBox"), "If you are not the affected party, explain your connection.");
        $("#relationshipExplain").focus();
        return;
      }

      const caseTypes = $$('input[name="caseType"]:checked').map(x => x.value);
      const caseOther = $("#caseTypeOtherChk").checked ? $("#caseTypeOther").value.trim() : "";
      if (caseOther) caseTypes.push(caseOther);
      if (caseTypes.length === 0) {
        show($("#errorBox"), "Select at least one case type (or use Other).");
        return;
      }

      const remedies = $$('input[name="remedy"]:checked').map(x => x.value);
      const remedyOther = $("#remedyOtherChk").checked ? $("#remedyOther").value.trim() : "";
      if (remedyOther) remedies.push(remedyOther);
      if (remedies.length === 0) {
        show($("#errorBox"), "Select at least one desired outcome (or use Other).");
        return;
      }

      if (!$("#truthCheck").checked || !$("#understandCheck").checked) {
        show($("#errorBox"), "You must accept both declaration checkboxes.");
        return;
      }

      const evidenceTypes = $$('input[name="evidenceType"]:checked').map(x => x.value);
      const evidenceOther = $("#evidenceOtherChk").checked ? $("#evidenceOther").value.trim() : "";
      if (evidenceOther) evidenceTypes.push(evidenceOther);

      const evidenceLinks = getListValues(evidenceList, "evidence");
      const witnesses = getListValues(witnessList, "witness");

      const start = $("#incidentDateStart").value;
      const end = $("#incidentDateEnd").value;
      if (end && end < start) {
        show($("#errorBox"), "Incident end date cannot be before the start date.");
        $("#incidentDateEnd").focus();
        return;
      }

      // Build submission
      const caseId = randomId();
      $("#caseId").textContent = caseId;

      lastSubmission = {
        caseId,
        submittedAt: new Date().toISOString(),
        client: {
          ign: $("#clientIgn").value.trim(),
          discord: $("#clientDiscord").value.trim(),
          affectedParty: affected === "yes",
          relationshipExplain: $("#relationshipExplain").value.trim() || null
        },
        defendant: {
          ign: $("#defendantIgn").value.trim(),
          alts: $("#defendantAlts").value.trim() || null
        },
        case: {
          types: caseTypes,
          incident: {
            startDate: start,
            endDate: end || null,
            location: $("#incidentLocation").value.trim(),
            description: $("#incidentDescription").value.trim()
          },
          evidence: {
            types: evidenceTypes,
            items: evidenceLinks
          },
          witnesses,
          damages: $("#damages").value.trim(),
          remedies,
          notes: $("#notes").value.trim() || null
        },
        declaration: {
          signature: $("#signature").value.trim(),
          date: $("#signDate").value
        }
      };

      const doc = buildPlaintiffDoc(lastSubmission);
      $("#output").textContent = doc;

      lastDocText = doc;
      lastDocLabel = "Plaintiff";

      show($("#successBox"), "Submitted. Copy the document, download it, or send it to Discord.");
      outputMovedToBottom = true;
      syncOutputPlacement();
      requestAnimationFrame(scrollBubbleIntoView);

      // Auto-send to Discord if enabled
      if ($("#autoWebhook").checked) {
        await sendToDiscordWebhook(doc, caseId, "Plaintiff", $("#successBox"));
      }
    });

    function fmtList(arr) {
      if (!arr || arr.length === 0) return "(none)";
      return arr.map((x, i) => `${i + 1}. ${x}`).join("\n");
    }

    function buildPlaintiffDoc(s) {
      const end = s.case.incident.endDate ? ` to ${s.case.incident.endDate}` : "";
      return [
        "VINTERRA SMP – LEGAL INTAKE (PLAINTIFF)",
        "====================================",
        `Case ID: ${s.caseId}`,
        `Submitted: ${new Date(s.submittedAt).toLocaleString()}`,
        "",
        "CLIENT",
        "------",
        `IGN: ${s.client.ign}`,
        `Discord: ${s.client.discord}`,
        `Affected party: ${s.client.affectedParty ? "Yes" : "No"}`,
        s.client.relationshipExplain ? `Connection: ${s.client.relationshipExplain}` : null,
        "",
        "DEFENDANT",
        "---------",
        `IGN: ${s.defendant.ign}`,
        s.defendant.alts ? `Other involved: ${s.defendant.alts}` : null,
        "",
        "CASE SUMMARY",
        "------------",
        `Types: ${s.case.types.join(", ")}`,
        `Date(s): ${s.case.incident.startDate}${end}`,
        `Location: ${s.case.incident.location}`,
        "",
        "DESCRIPTION",
        "-----------",
        s.case.incident.description,
        "",
        "EVIDENCE",
        "--------",
        `Evidence types: ${s.case.evidence.types.length ? s.case.evidence.types.join(", ") : "(none selected)"}`,
        "Evidence items:",
        fmtList(s.case.evidence.items),
        "",
        "WITNESSES",
        "---------",
        fmtList(s.case.witnesses),
        "",
        "DAMAGES",
        "-------",
        s.case.damages,
        "",
        "REQUESTED OUTCOME",
        "-----------------",
        fmtList(s.case.remedies),
        "",
        "ADDITIONAL NOTES",
        "----------------",
        s.case.notes || "(none)",
        "",
        "DECLARATION",
        "-----------",
        `Signed by: ${s.declaration.signature}`,
        `Date: ${s.declaration.date}`
      ].filter((line) => line !== null && line !== undefined).join("\n");
    }

    function buildDefendantDoc(d) {
      return [
        "VINTERRA SMP – LEGAL INTAKE (DEFENDANT)",
        "====================================",
        `Record ID: ${d.recordId}`,
        d.servedCaseId ? `Served Case ID: ${d.servedCaseId}` : null,
        `Submitted: ${new Date(d.submittedAt).toLocaleString()}`,
        "",
        "DEFENDANT",
        "---------",
        `IGN: ${d.defendant.ign}`,
        `Discord: ${d.defendant.discord}`,
        `Served date: ${d.defendant.servedDate}`,
        "",
        "PLAINTIFF",
        "---------",
        `IGN: ${d.plaintiff.ign}`,
        d.plaintiff.discord ? `Discord: ${d.plaintiff.discord}` : null,
        "",
        "ALLEGATIONS",
        "----------",
        d.claim.allegations,
        "",
        "RESPONSE",
        "--------",
        `Position: ${d.response.position}`,
        "",
        d.response.narrative,
        "",
        "DEFENSES",
        "--------",
        d.response.defenses,
        "",
        "EVIDENCE",
        "--------",
        `Evidence types: ${d.evidence.types.length ? d.evidence.types.join(", ") : "(none selected)"}`,
        "Evidence items:",
        fmtList(d.evidence.items),
        "Witnesses:",
        fmtList(d.evidence.witnesses),
        "",
        "RESOLUTION",
        "----------",
        `Settlement: ${d.resolution.settlement}`,
        "Preferred outcomes:",
        fmtList(d.resolution.outcomes),
        `Countersuit: ${d.resolution.counterSuit}`,
        d.resolution.counterExplain ? `Countersuit notes: ${d.resolution.counterExplain}` : null,
        "",
        "DECLARATION",
        "-----------",
        `Signed by: ${d.declaration.signature}`,
        `Date: ${d.declaration.date}`
      ].filter((line) => line !== null && line !== undefined).join("\n");
    }

    // Defendant submit
    $("#defendantForm").addEventListener("submit", async (ev) => {
      ev.preventDefault();
      hide($("#defErrorBox"));
      hide($("#defSuccessBox"));

      const required = ["defIgn", "defDiscord", "servedDate", "plaintiffIgn", "allegations", "defResponse", "defenses", "defSignature", "defSignDate"];
      for (const id of required) {
        const el = document.getElementById(id);
        if (!el.value.trim()) {
          show($("#defErrorBox"), `Missing required field: ${id}`);
          el.focus();
          return;
        }
      }

      const position = $$('input[name="position"]:checked')[0]?.value;
      if (!position) { show($("#defErrorBox"), "Pick your position (deny/partial/admit)."); return; }

      const settlement = $$('input[name="settlement"]:checked')[0]?.value;
      if (!settlement) { show($("#defErrorBox"), "Pick settlement preference."); return; }

      const counter = $$('input[name="counter"]:checked')[0]?.value;
      if (!counter) { show($("#defErrorBox"), "Pick whether you want to countersue."); return; }

      if (!$("#defTruthCheck").checked || !$("#defUnderstandCheck").checked) {
        show($("#defErrorBox"), "You must accept both declaration checkboxes.");
        return;
      }

      const defEvidenceTypes = $$('input[name="defEvidenceType"]:checked').map(x => x.value);
      const defEvidenceOther = $("#defEvidenceOtherChk").checked ? $("#defEvidenceOther").value.trim() : "";
      if (defEvidenceOther) defEvidenceTypes.push(defEvidenceOther);

      const defEvidenceItems = getListValues(defEvidenceList, "defEvidence");
      const defWitnesses = getListValues(defWitnessList, "defWitness");

      const outcomes = $$('input[name="defOutcome"]:checked').map(x => x.value);
      const outcomeOther = $("#defOutcomeOtherChk").checked ? $("#defOutcomeOther").value.trim() : "";
      if (outcomeOther) outcomes.push(outcomeOther);
      if (outcomes.length === 0) {
        show($("#defErrorBox"), "Select at least one preferred outcome (or use Other).");
        return;
      }

      // Use served Case ID if provided, otherwise generate a defense record id
      const servedId = $("#suedCaseId").value.trim();
      const recordId = servedId || randomId();
      $("#caseId").textContent = recordId;

      lastDefense = {
        recordId,
        servedCaseId: servedId || null,
        submittedAt: new Date().toISOString(),
        defendant: {
          ign: $("#defIgn").value.trim(),
          discord: $("#defDiscord").value.trim(),
          servedDate: $("#servedDate").value
        },
        plaintiff: {
          ign: $("#plaintiffIgn").value.trim(),
          discord: $("#plaintiffDiscord").value.trim() || null
        },
        claim: { allegations: $("#allegations").value.trim() },
        response: {
          position,
          narrative: $("#defResponse").value.trim(),
          defenses: $("#defenses").value.trim()
        },
        evidence: {
          types: defEvidenceTypes,
          items: defEvidenceItems,
          witnesses: defWitnesses
        },
        resolution: {
          settlement,
          outcomes,
          counterSuit: counter,
          counterExplain: $("#counterExplain").value.trim() || null
        },
        declaration: {
          signature: $("#defSignature").value.trim(),
          date: $("#defSignDate").value
        }
      };

      const doc = buildDefendantDoc(lastDefense);
      $("#output").textContent = doc;

      lastDocText = doc;
      lastDocLabel = "Defendant";

      show($("#defSuccessBox"), "Submitted. Copy the document, download it, or send it to Discord.");
      outputMovedToBottom = true;
      syncOutputPlacement();
      requestAnimationFrame(scrollBubbleIntoView);

      // Auto-send to Discord if enabled
      if ($("#autoWebhook").checked) {
        await sendToDiscordWebhook(doc, recordId, "Defendant", $("#defSuccessBox"));
      }
    });

    // Manual send to Discord
    $("#webhookBtn").addEventListener("click", async () => {
      // Decide which status box to use based on which form is currently visible
      const plaintiffVisible = $("#intakeForm").style.display !== "none";
      const statusEl = plaintiffVisible ? $("#successBox") : $("#defSuccessBox");

      hide($("#errorBox"));
      hide($("#defErrorBox"));

      if (!lastDocText) {
        show(statusEl, "Nothing to send yet. Submit a form first.");
        statusEl.classList.remove("success");
        statusEl.classList.add("error");
        statusEl.style.display = "block";
        return;
      }

      // Use the current Case ID pill if it looks like one, otherwise generate a filename
      const pillId = $("#caseId").textContent;
      const filenameBase = pillId && pillId !== "Not submitted" ? pillId : randomId();

      await sendToDiscordWebhook(lastDocText, filenameBase, lastDocLabel || "Submission", statusEl);
    });

    // Copy/download buttons
    $("#copyBtn").addEventListener("click", async () => {
      const text = $("#output").textContent;
      const plaintiffVisible = $("#intakeForm").style.display !== "none";
      const okEl = plaintiffVisible ? $("#successBox") : $("#defSuccessBox");
      const badEl = plaintiffVisible ? $("#errorBox") : $("#defErrorBox");
      try{
        await navigator.clipboard.writeText(text);
        show(okEl, "Copied to clipboard.");
      }catch(e){
        show(badEl, "Copy failed. Highlight the doc and do it the old-fashioned way.");
      }
    });

    $("#downloadBtn").addEventListener("click", () => {
      const text = $("#output").textContent;
      const pillId = $("#caseId").textContent;
      const id = pillId && pillId !== "Not submitted" ? pillId : "vinterra-case";
      downloadText(`${id}.txt`, text);
      const plaintiffVisible = $("#intakeForm").style.display !== "none";
      show(plaintiffVisible ? $("#successBox") : $("#defSuccessBox"), "Downloaded document.");
    });

  </script>
</body>
</html>
